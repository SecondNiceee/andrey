# 📊 Схема Миграции PNG → WebP

## 🔄 Полный Процесс

```
┌─────────────────────────────────────────────────────────────────────┐
│                  📊 ПОЛНАЯ МИГРАЦИЯ PNG → WebP                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  npm run migrate-to-webp                                           │
│  │                                                                  │
│  ├─────────────────────────────────────────────────────────────┐   │
│  │ ШАГИ ВЫПОЛНЯЮТСЯ АВТОМАТИЧЕСКИ ПО ПОРЯДКУ                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                           ↓                                        │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │  ⭐ ШАГ 1: КОНВЕРТАЦИЯ                                      │   │
│  │  convert-all-to-webp.js                                    │   │
│  │                                                            │   │
│  │  ВХОДНЫЕ ДАННЫЕ:                                           │   │
│  │  ✓ img/*.png (150+ файлов)                                │   │
│  │  ✓ img/*.jpg                                              │   │
│  │  ✓ img-no/*.png                                           │   │
│  │                                                            │   │
│  │  ПРОЦЕСС:                                                 │   │
│  │  1. Читает все файлы из img/ и img-no/                   │   │
│  │  2. Конвертирует в WebP с качеством 70%                  │   │
│  │  3. Сохраняет рядом с оригиналом                         │   │
│  │  4. Создает processed-images.json                         │   │
│  │                                                            │   │
│  │  ВЫХОДНЫЕ ДАННЫЕ:                                          │   │
│  │  ✓ img/*.webp (150+ новых файлов)                        │   │
│  │  ✓ scripts/processed-images.json                         │   │
│  │  ✓ img/*.png ВСЕ ЕЩЕ ЗДЕСЬ (удаляем позже)             │   │
│  │                                                            │   │
│  │  РЕЗУЛЬТАТ: ✅ Успешно создано 150 WebP файлов           │   │
│  └────────────────────────────────────────────────────────────┘   │
│                           ↓                                        │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │  ⭐ ШАГ 2: ОБНОВЛЕНИЕ HTML                                 │   │
│  │  update-html-comprehensive.js                              │   │
│  │                                                            │   │
│  │  ВХОДНЫЕ ДАННЫЕ:                                           │   │
│  │  ✓ index.html (3176 строк)                               │   │
│  │  ✓ processed-images.json                                  │   │
│  │                                                            │   │
│  │  ПРОЦЕСС:                                                 │   │
│  │  1. Читает processed-images.json                          │   │
│  │  2. Находит все *.html файлы                             │   │
│  │  3. Заменяет ссылки:                                      │   │
│  │     ./img/logo.png  → ./img/logo.webp                    │   │
│  │     img/bottle.png  → img/bottle.webp                    │   │
│  │  4. Сохраняет обновленный HTML                           │   │
│  │                                                            │   │
│  │  ВЫХОДНЫЕ ДАННЫЕ:                                          │   │
│  │  ✓ index.html (обновлено, +120 WebP ссылок)            │   │
│  │  ✓ Все другие *.html (если есть)                        │   │
│  │                                                            │   │
│  │  РЕЗУЛЬТАТ: ✅ Обновлено 120 ссылок в HTML              │   │
│  └────────────────────────────────────────────────────────────┘   │
│                           ↓                                        │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │  ⭐ ШАГ 3: УДАЛЕНИЕ PNG                                    │   │
│  │  delete-old-png.js                                         │   │
│  │                                                            │   │
│  │  ВХОДНЫЕ ДАННЫЕ:                                           │   │
│  │  ✓ processed-images.json (список файлов)                 │   │
│  │  ✓ img/*.png (150 файлов)                                │   │
│  │                                                            │   │
│  │  ПРОЦЕСС:                                                 │   │
│  │  1. Читает processed-images.json                          │   │
│  │  2. Для каждого файла:                                   │   │
│  │     - Проверяет существование                            │   │
│  │     - Удаляет img/logo.png                              │   │
│  │     - Удаляет img/bottle.png                            │   │
│  │     - И так для всех PNG                                │   │
│  │  3. Логирует результаты                                  │   │
│  │                                                            │   │
│  │  ВЫХОДНЫЕ ДАННЫЕ:                                          │   │
│  │  ✓ img/ - только WebP файлы                             │   │
│  │  ✓ img-no/ - только WebP файлы                          │   │
│  │  ✓ img/*.png - УДАЛЕНЫ ❌                                │   │
│  │                                                            │   │
│  │  РЕЗУЛЬТАТ: ✅ Удалено 150 PNG файлов                    │   │
│  └────────────────────────────────────────────────────────────┘   │
│                           ↓                                        │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │  ✨ МИГРАЦИЯ ЗАВЕРШЕНА УСПЕШНО!                            │   │
│  │                                                            │   │
│  │  ✅ Все PNG файлы конвертированы в WebP                  │   │
│  │  ✅ Все HTML файлы обновлены                             │   │
│  │  ✅ Старые PNG файлы удалены                             │   │
│  │  ✅ Сайт полностью на WebP!                              │   │
│  └────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

## 📁 Структура Файлов: До и После

### ДО МИГРАЦИИ

```
проект/
├── img/
│   ├── logo.png ........................ (12 KB PNG)
│   ├── bottle1.png ..................... (45 KB PNG)
│   ├── bottle2.png ..................... (48 KB PNG)
│   ├── img-card1.png ................... (32 KB PNG)
│   ├── img-card2.png ................... (35 KB PNG)
│   └── [и еще 145+ PNG файлов]
│
├── img-no/
│   └── [PNG файлы]
│
├── index.html .......................... (ссылается на PNG)
├── catalog.html ........................ (ссылается на PNG)
│
└── scripts/
    ├── convert-all-to-webp.js
    ├── update-html-to-webp.js
    └── [другие скрипты]
```

### ПОСЛЕ МИГРАЦИИ

```
проект/
├── img/
│   ├── logo.webp ....................... (4 KB WebP)  ✅
│   ├── bottle1.webp .................... (15 KB WebP) ✅
│   ├── bottle2.webp .................... (16 KB WebP) ✅
│   ├── img-card1.webp .................. (11 KB WebP) ✅
│   ├── img-card2.webp .................. (12 KB WebP) ✅
│   └── [и еще 145+ WebP файлов]
│
├── img-no/
│   └── [WebP файлы]
│
├── index.html .......................... (ссылается на WebP) ✅
├── catalog.html ........................ (ссылается на WebP) ✅
│
└── scripts/
    ├── convert-all-to-webp.js
    ├── update-html-comprehensive.js
    ├── delete-old-png.js
    ├── full-migration-to-webp.js ........ (НОВЫЙ - мастер скрипт)
    └── processed-images.json ........... (лист обработанных файлов)
```

## 🎯 Соотношение Размеров

```
PNG vs WebP (Примеры):

logo.png (12 KB)      →  logo.webp (4 KB)      📉 -67%
bottle1.png (45 KB)   →  bottle1.webp (15 KB)  📉 -67%
bottle2.png (48 KB)   →  bottle2.webp (16 KB)  📉 -67%
img-card.png (32 KB)  →  img-card.webp (11 KB) 📉 -66%

ВСЕГО: ~9 MB PNG       →  ~3.5 MB WebP         📉 -62% 🎉
```

## 🚀 Три Варианта Запуска

### Вариант 1: ВСЕ СРАЗУ (Рекомендуется)
```bash
npm run migrate-to-webp
```
Запускает все три этапа подряд в одной команде.

### Вариант 2: По отдельности с контролем
```bash
npm run convert-all-webp           # Только конвертация
npm run update-html-comprehensive  # Только обновление HTML
npm run delete-png                 # Только удаление PNG
```

### Вариант 3: Старые команды (если нужны)
```bash
npm run optimize-images  # Конвертация + обновление HTML (без удаления)
```

## ⚡ Что Происходит в Каждом Скрипте

```
КОНВЕРТАЦИЯ (convert-all-to-webp.js)
├─ Сканирует img/ и img-no/ директории
├─ Для каждого PNG/JPG:
│  ├─ Читает файл с помощью Sharp
│  ├─ Конвертирует в WebP
│  └─ Сохраняет рядом
├─ Создает processed-images.json со списком
└─ Результат: PNG + WebP в одной папке

ОБНОВЛЕНИЕ HTML (update-html-comprehensive.js)
├─ Находит все *.html файлы
├─ Читает processed-images.json
├─ Для каждого HTML файла:
│  ├─ Ищет все ссылки на PNG
│  ├─ Заменяет их на WebP
│  └─ Сохраняет обновленный файл
└─ Результат: HTML ссылаются на WebP

УДАЛЕНИЕ (delete-old-png.js)
├─ Читает processed-images.json
├─ Для каждого PNG в списке:
│  ├─ Проверяет что файл существует
│  ├─ Удаляет PNG
│  └─ Логирует результат
└─ Результат: Только WebP остается
```

## 🔍 Логирование и Результаты

Каждый скрипт выводит подробные логи:

```
✅ img/logo.png → logo.webp
✅ img/bottle1.png → bottle1.webp
✅ img/bottle2.png → bottle2.webp
❌ img/corrupted.png - ошибка при обработке
...
✨ Конвертация завершена!
✅ Успешно обработано: 150
❌ Ошибок: 0
```

## 💾 Файл processed-images.json

Он выглядит так:
```json
[
  {
    "oldName": "logo.png",
    "newName": "logo.webp",
    "dir": "img"
  },
  {
    "oldName": "bottle1.png",
    "newName": "bottle1.webp",
    "dir": "img"
  }
]
```

Используется вторым и третьим скриптом для отслеживания файлов.
